---
title: おいしいCookie、まずいCookie
tags:
  - '初心者'
  - 'Cookie'
  - 'アンチパターン'
private: false
updated_at: ''
id: null
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに

最近、[［改訂新版］プロになるためのWeb技術入門](https://gihyo.jp/book/2024/978-4-297-14571-2)を読みCookieの話が出てきたので、
どんな風に使っていくか、アンチパターンなどをまとめてみました。

## Cookieとは 🍪

簡単にCookieって何？どんなことができるの？などを説明します。

> Cookie（ウェブ Cookie、ブラウザー Cookie とも呼ぶ）は、サーバーがユーザーのウェブブラウザーに送信する小さなデータです。ブラウザーは Cookie を保存したり、新しい Cookie を作成したり、既存の Cookie を変更したり、後でリクエストされたときに同じサーバーにそれらを送り返したりすることができます。 Cookie により、ウェブアプリケーションは限られた量のデータを格納し、状態についての情報を記憶することができます。HTTP プロトコルは既定ではステートレスだからです。
>
> https://developer.mozilla.org/ja/docs/Web/HTTP/Guides/Cookies


細かく書かれていますが、  
要は、**Cookieは「ブラウザに保存される小さなメモ**です。

サーバーが「次回また来たときに、誰か分かるように」ブラウザに渡す識別情報を持っています。

### Cookieがないとどうなる？

前提としてクライアント（ブラウザ）とサーバーとのやりとりはHTTP通信で行われています。  
ただ、HTTP通信は1回の通信毎に完結する設計になっています。（ステートレス）

ということは、サーバーは通信した記憶をすぐに忘れてしまい、  
次のリクエストを投げてもさっきと同じユーザーだということがわかりません。

これは何が不便なのでしょうか？？

Chromeなどのブラウザを使ってECサイトを利用するケースで考えてみます。

あなたは、ある商品Aをカートに入れました。  
次に商品Bのページを見に行くとカートの中の商品Aが無くなっています。。。

あなた（ユーザー）の情報を保持できずに、一回きりの通信しか対応できません。

他にもそもそもログイン情報を保持できないので、  
毎回IDとパスワードを入力する手間や、ユーザーの設定も毎回リセットされます。

現代の複雑なWebアプリケーションで情報が保持できないのは致命傷ですよね、、、

### ステートフルを実現する

このような課題を解決するのがCookieです。

一回きりのHTTP通信でも、ユーザーとのやり取り（セッション）やユーザーを一意に特定できれば情報を保持し継続性を持たせることができます。

> セッションとは、、、
>
> クライアントとサーバーの「一連のやりとり」です。  
> たとえば、居酒屋に入って注文、追加などで伝票（セッションID）が付けられ、お会計までの一連の流れのことです。
> 

Cookieの中に、ユーザーやセッションを特定するIDを持たせることで実現しています。

「ならCookieの中に全てカート内の情報などを持たせたらどうなの？」という疑問もあると思います。

Cookieは大量な情報を持っておくことを目的としていない、改ざんによるセキュリティリスクなどがあるので避けた方が良いです。

基本的な情報処理はサーバー側にさせた方が良いので、  
Cookieはユーザーやセッションを特定するタグ（ラベル）を持っているというイメージです。

セッションIDやユーザーIDなどが流出すると、  
それらのやりとりが乗っ取られるのでCookieの扱いは注意が必要です。

そのあたり”まずいCookie”パートで説明していきます。


# おいしいCookie 😋

このパートでは、抑えておきたいCookieの設定のポイントを整理していきます。

| **属性名** | **推奨される値** | **設定する理由（メリット）** | **設定しない際のリスク** |
| --- | --- | --- | --- |
| **HttpOnly** | `true` | JavaScriptからのアクセスを禁止し、XSSによるトークン奪取を防ぐ。 | XSS脆弱性があった場合、`document.cookie`で即座に秘密情報が盗まれる。 |
| **Secure** | `true` | HTTPS通信時のみCookieを送信するように制限する。 | HTTP通信（公衆無線LAN等）でパケットキャプチャされ、盗聴される。 |
| **SameSite** | `Lax` (または `Strict`) | クロスサイトリクエストでの送信を制限し、CSRF攻撃を防御する。 | 他のサイトから勝手にリクエスト（退会処理や送金など）を投げられる。 |
| **Path** | `/` | サイト内の全パスでCookieを有効にする（意図的でない限り限定しない）。 | パスを絞りすぎると、特定のディレクトリでログイン状態が維持されないバグを生む。 |
| **Domain** | **指定しない** (省略) | 現在のホストのみに限定する。サブドメインへの漏洩を防ぐ。 | サブドメインで設定したものが本体等で上書き・窃取される。 |
| **Max-Age / Expires** | セッションCookie（未設定）<br>または短期間（3600〜86400秒） | 有効期限を明示的に管理し、古いセッションを自動削除する。セッションCookieはブラウザ終了時に削除される。 | 無期限や長期間（数年）の設定は、端末紛失・盗難時の被害期間を延長させる。GDPRなどで「最小保持期間」違反の可能性。 |
| **Prefix: __Host-** | `__Host-session_id` 形式 | `Secure`+`Path=/`+`Domain未指定`を強制する。サーバー側での厳格な検証が不要になる。 | 攻撃者がサブドメインやHTTPで同名Cookieを上書きし、セッション固定攻撃を仕掛けられる可能性。 |
| **Prefix: __Secure-** | `__Secure-user_pref` 形式 | `Secure`属性を強制する。HTTPSでのみ設定・送信されることが保証される。 | HTTP通信で同名Cookieが設定され、中間者攻撃でセキュアなCookieが上書きされる（ダウングレード攻撃）。 |


基本的にはすべて設定した方が良いと思います。  
（セキュリティの厳格さは利便性とのトレードオフなので要件次第ですが、、、）

設定する値としては次のようなイメージになります。

```bash
# セッション管理用の設定イメージ
Set-Cookie: __Host-session_id=abc123def; Secure; HttpOnly; SameSite=Lax; Path=/
```

# まずいCookie 🤮

Cookieは便利な技術で、現代のWeb開発には必須の知識になっています。

しかし、正しく設定しないと簡単にセキュリティリスクに繋がります。

よくある落とし穴に落ちないように、アンチパターンに触れていきましょう。

もちろん以下のものだけではありません。  
実装時にベテランの方に相談するのもいいかもしれませんね。



| **アンチパターン** | **起こりうる最悪のケース** | **改善後のアクション** |
| --- | --- | --- |
| **生データの保持** | 権限昇格・個人情報漏洩 | サーバー側セッション管理に移行 |
| **LocalStorage保存** | 全ユーザーのセッション乗っ取り | `HttpOnly` Cookieへ移行 |
| **広いDomain設定** | サブドメイン経由の攻撃 | Domain属性を削除（省略） |
| **巨大なCookie** | サイトが重い・431エラー | `LocalStorage` または DBへ移行 |
| **SameSite=None** | CSRF攻撃による勝手な操作 | `SameSite=Lax` をデフォルトにする |


## 1. 生データの保持

## 2. LocalStorage保存

## 3. 広いDomain設定

## 4. 巨大なCookie

## 5. SameSite=None



# さいごに

Cookieという現代に欠かせない技術について、  
推奨パターンとアンチパターンを整理してみました。

これだけが絶対の正解ということは決してありませんが、  
理解のレベルがCookieとは？からざっくり何に気をつけるかわかるようになれば嬉しいです。

「こんなセキュリティリスクがあるからこの設定が必要」  
というような理解をしておくと実戦で使えるものになると思いました。